@page "/setup"
@using Microsoft.AspNetCore.Identity
@using RTOWebLMS.Models
@using RTOWebLMS.Data
@inject UserManager<User> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject LmsDbContext DbContext

<PageTitle>Database Setup</PageTitle>

<div class="container mt-5">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3>Database Setup</h3>
        </div>
        <div class="card-body">
            @if (setupComplete)
            {
                <div class="alert alert-success">
                    <h4>‚úÖ Setup Complete!</h4>
                    <p><strong>Admin User Created:</strong></p>
                    <ul>
                        <li><strong>Email:</strong> admin@localhost.com</li>
                        <li><strong>Password:</strong> Admin123!</li>
                    </ul>
                    <a href="/login" class="btn btn-primary">Go to Login</a>
                </div>
            }
            else if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">
                    <h4>‚ùå Error</h4>
                    <p>@errorMessage</p>
                    <button class="btn btn-warning" @onclick="RunSetup">Try Again</button>
                </div>
            }
            else if (isRunning)
            {
                <div class="alert alert-info">
                    <h4>‚è≥ Running Setup...</h4>
                    <p>@statusMessage</p>
                </div>
            }
            else
            {
                <p>This will create the database, default tenant, and admin user.</p>
                <button class="btn btn-primary" @onclick="RunSetup">Run Setup</button>
            }

            @if (logs.Count > 0)
            {
                <div class="mt-4">
                    <h5>Setup Log:</h5>
                    <pre class="bg-light p-3 border">@string.Join("\n", logs)</pre>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private bool setupComplete = false;
    private bool isRunning = false;
    private string? errorMessage = null;
    private string statusMessage = "";
    private List<string> logs = new();

    private async Task RunSetup()
    {
        setupComplete = false;
        isRunning = true;
        errorMessage = null;
        logs.Clear();

        try
        {
            Log("Starting database setup...");
            statusMessage = "Creating database...";
            StateHasChanged();
            await Task.Delay(100);

            // Ensure database exists
            DbContext.Database.EnsureCreated();
            Log("‚úÖ Database created");

            // Create default tenant
            statusMessage = "Creating default tenant...";
            StateHasChanged();
            await Task.Delay(100);

            var tenant = DbContext.Tenants.FirstOrDefault(t => t.Id == "default-tenant");
            if (tenant == null)
            {
                tenant = new Tenant
                {
                    Id = "default-tenant",
                    Name = "Default Organization",
                    Subdomain = "localhost",
                    CreatedAt = DateTime.UtcNow,
                    IsActive = true
                };
                DbContext.Tenants.Add(tenant);
                await DbContext.SaveChangesAsync();
                Log("‚úÖ Default tenant created");
            }
            else
            {
                Log("‚ÑπÔ∏è  Default tenant already exists");
            }

            // Create roles
            statusMessage = "Creating roles...";
            StateHasChanged();
            await Task.Delay(100);

            foreach (var roleName in new[] { "Admin", "Instructor", "Student" })
            {
                if (!await RoleManager.RoleExistsAsync(roleName))
                {
                    await RoleManager.CreateAsync(new IdentityRole(roleName));
                    Log($"‚úÖ Role '{roleName}' created");
                }
                else
                {
                    Log($"‚ÑπÔ∏è  Role '{roleName}' already exists");
                }
            }

            // Create or reset admin user
            statusMessage = "Creating admin user...";
            StateHasChanged();
            await Task.Delay(100);

            var adminEmail = "admin@localhost.com";
            var existingAdmin = await UserManager.FindByEmailAsync(adminEmail);

            if (existingAdmin != null)
            {
                // Delete existing admin to recreate with correct password
                Log("üóëÔ∏è  Deleting existing admin user...");
                await UserManager.DeleteAsync(existingAdmin);
            }

            var adminUser = new User
            {
                UserName = adminEmail,
                Email = adminEmail,
                EmailConfirmed = true,
                TenantId = tenant.Id,
                FirstName = "Admin",
                LastName = "User",
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            };

            var result = await UserManager.CreateAsync(adminUser, "Admin123!");

            if (result.Succeeded)
            {
                await UserManager.AddToRoleAsync(adminUser, "Admin");
                Log("‚úÖ Admin user created successfully");
                Log($"   Email: {adminEmail}");
                Log($"   Password: Admin123!");
            }
            else
            {
                var errors = string.Join(", ", result.Errors.Select(e => e.Description));
                throw new Exception($"Failed to create admin user: {errors}");
            }

            // Auto-restore courses from backup if available
            statusMessage = "Checking for course backups...";
            StateHasChanged();
            await Task.Delay(100);

            var appDataPath = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData);
            var backupPath = Path.Combine(appDataPath, "RTODesktopLMS", "backup");

            if (Directory.Exists(backupPath))
            {
                var backupFiles = Directory.GetFiles(backupPath, "*.db");
                if (backupFiles.Length > 0)
                {
                    Log($"üì¶ Found {backupFiles.Length} backup file(s)");
                    var latestBackup = backupFiles.OrderByDescending(f => new FileInfo(f).CreationTime).First();
                    Log($"üìÇ Using latest backup: {Path.GetFileName(latestBackup)}");

                    statusMessage = "Restoring courses from backup...";
                    StateHasChanged();
                    await Task.Delay(100);

                    await RestoreCoursesFromBackup(latestBackup, tenant);
                }
                else
                {
                    Log("‚ÑπÔ∏è  No backup files found");
                }
            }
            else
            {
                Log("‚ÑπÔ∏è  Backup folder does not exist");
            }

            statusMessage = "Setup complete!";
            setupComplete = true;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            Log($"‚ùå Error: {ex.Message}");
        }
        finally
        {
            isRunning = false;
            StateHasChanged();
        }
    }

    private async Task RestoreCoursesFromBackup(string backupFilePath, Tenant tenant)
    {
        try
        {
            var optionsBuilder = new DbContextOptionsBuilder<LmsDbContext>();
            optionsBuilder.UseSqlite($"Data Source={backupFilePath}");

            using var backupContext = new LmsDbContext(optionsBuilder.Options);

            var courseCount = await backupContext.Courses.CountAsync();
            Log($"üìä Found {courseCount} courses in backup");

            if (courseCount == 0)
            {
                Log("‚ÑπÔ∏è  No courses to restore");
                return;
            }

            var courses = await backupContext.Courses
                .Include(c => c.Modules)
                    .ThenInclude(m => m.Lessons)
                .ToListAsync();

            int imported = 0;
            foreach (var course in courses)
            {
                var exists = await DbContext.Courses.AnyAsync(c => c.Slug == course.Slug);
                if (exists)
                {
                    Log($"   ‚è≠Ô∏è  Skipping: {course.Title} (already exists)");
                    continue;
                }

                var newCourse = new Course
                {
                    Id = course.Id,
                    TenantId = tenant.Id,
                    Title = course.Title,
                    Slug = course.Slug,
                    Description = course.Description,
                    UnitCode = course.UnitCode,
                    Level = course.Level,
                    Duration = course.Duration,
                    IsPublished = course.IsPublished,
                    ThumbnailUrl = course.ThumbnailUrl,
                    InstructorId = course.InstructorId,
                    CreatedAt = course.CreatedAt,
                    UpdatedAt = course.UpdatedAt
                };

                DbContext.Courses.Add(newCourse);
                Log($"   ‚úÖ Restoring: {course.Title}");
                imported++;

                foreach (var module in course.Modules.OrderBy(m => m.OrderIndex))
                {
                    var newModule = new Module
                    {
                        Id = module.Id,
                        TenantId = tenant.Id,
                        CourseId = newCourse.Id,
                        Title = module.Title,
                        Description = module.Description,
                        OrderIndex = module.OrderIndex,
                        CreatedAt = module.CreatedAt,
                        UpdatedAt = module.UpdatedAt
                    };

                    DbContext.Modules.Add(newModule);

                    foreach (var lesson in module.Lessons.OrderBy(l => l.OrderIndex))
                    {
                        var newLesson = new Lesson
                        {
                            Id = lesson.Id,
                            TenantId = tenant.Id,
                            ModuleId = newModule.Id,
                            Title = lesson.Title,
                            Content = lesson.Content,
                            LessonType = lesson.LessonType,
                            OrderIndex = lesson.OrderIndex,
                            Duration = lesson.Duration,
                            IsPublished = lesson.IsPublished,
                            VideoUrl = lesson.VideoUrl,
                            QuizId = lesson.QuizId,
                            SimulationId = lesson.SimulationId,
                            CreatedAt = lesson.CreatedAt,
                            UpdatedAt = lesson.UpdatedAt
                        };

                        DbContext.Lessons.Add(newLesson);
                    }
                }
            }

            await DbContext.SaveChangesAsync();
            Log($"‚úÖ Successfully restored {imported} courses!");
        }
        catch (Exception ex)
        {
            Log($"‚ùå Error restoring courses: {ex.Message}");
        }
    }

    private void Log(string message)
    {
        logs.Add($"[{DateTime.Now:HH:mm:ss}] {message}");
    }
}
