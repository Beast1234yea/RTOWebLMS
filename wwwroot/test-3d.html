<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        #info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #container {
            width: 100%;
            height: 600px;
            background: #e0e0e0;
            border-radius: 8px;
        }
        .log {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="info">
        <h2>3D Model Loading Test</h2>
        <p>Testing: <strong id="model-path">/models/forklift/ForkliftElecrtic.gltf</strong></p>
        <p>Status: <strong id="status">Initializing...</strong></p>
    </div>

    <div id="container"></div>

    <div class="log" id="log"></div>

    <script type="module">
        const log = document.getElementById('log');
        const statusEl = document.getElementById('status');

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef5350' : type === 'success' ? '#66bb6a' : '#aed581';
            log.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        addLog('Starting 3D viewer test...');
        statusEl.textContent = 'Loading Three.js...';

        try {
            addLog('Importing Three.js from CDN...');

            import('https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js')
                .then(THREE => {
                    addLog('Three.js loaded successfully!', 'success');
                    statusEl.textContent = 'Loading GLTF Loader...';

                    return Promise.all([
                        THREE,
                        import('https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/loaders/GLTFLoader.js'),
                        import('https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/controls/OrbitControls.js')
                    ]);
                })
                .then(([THREE, { GLTFLoader }, { OrbitControls }]) => {
                    addLog('GLTFLoader and OrbitControls loaded!', 'success');
                    statusEl.textContent = 'Setting up scene...';

                    const container = document.getElementById('container');

                    // Scene
                    const scene = new THREE.default.Scene();
                    scene.background = new THREE.default.Color(0xe0e0e0);

                    // Camera
                    const camera = new THREE.default.PerspectiveCamera(
                        50,
                        container.clientWidth / container.clientHeight,
                        0.1,
                        1000
                    );
                    camera.position.set(4, 3, 6);

                    // Renderer
                    const renderer = new THREE.default.WebGLRenderer({ antialias: true });
                    renderer.setSize(container.clientWidth, container.clientHeight);
                    renderer.setPixelRatio(window.devicePixelRatio);
                    container.appendChild(renderer.domElement);

                    addLog('Scene, camera, and renderer created', 'success');

                    // Lights
                    const ambientLight = new THREE.default.AmbientLight(0xffffff, 0.7);
                    scene.add(ambientLight);

                    const directionalLight = new THREE.default.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(5, 10, 5);
                    scene.add(directionalLight);

                    addLog('Lights added');

                    // Controls
                    const controls = new OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.autoRotate = true;

                    addLog('Controls initialized');

                    // Ground
                    const groundGeometry = new THREE.default.PlaneGeometry(20, 20);
                    const groundMaterial = new THREE.default.MeshStandardMaterial({ color: 0xcccccc });
                    const ground = new THREE.default.Mesh(groundGeometry, groundMaterial);
                    ground.rotation.x = -Math.PI / 2;
                    ground.position.y = -0.5;
                    scene.add(ground);

                    addLog('Ground plane added');

                    // Animation
                    function animate() {
                        requestAnimationFrame(animate);
                        controls.update();
                        renderer.render(scene, camera);
                    }
                    animate();

                    addLog('Animation loop started', 'success');
                    statusEl.textContent = 'Loading 3D model...';

                    // Test if file is accessible first
                    addLog('Testing if GLTF file is accessible...');
                    fetch('/models/forklift/ForkliftElecrtic.gltf')
                        .then(response => {
                            addLog(`Fetch response status: ${response.status} ${response.statusText}`);
                            addLog(`Content-Type: ${response.headers.get('content-type')}`);

                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.text();
                        })
                        .then(text => {
                            addLog(`File size: ${text.length} bytes`, 'success');
                            addLog('File is accessible! Now loading with GLTFLoader...', 'success');

                            // Load with GLTFLoader
                            const loader = new GLTFLoader();

                            loader.load(
                                '/models/forklift/ForkliftElecrtic.gltf',
                                function(gltf) {
                                    addLog('GLTF loaded successfully!', 'success');
                                    statusEl.textContent = 'Model loaded!';

                                    const model = gltf.scene;

                                    // Center and scale
                                    const box = new THREE.default.Box3().setFromObject(model);
                                    const center = box.getCenter(new THREE.default.Vector3());
                                    const size = box.getSize(new THREE.default.Vector3());

                                    addLog(`Model size: ${size.x.toFixed(2)} x ${size.y.toFixed(2)} x ${size.z.toFixed(2)}`);

                                    const maxDim = Math.max(size.x, size.y, size.z);
                                    const scale = 2.5 / maxDim;
                                    model.scale.multiplyScalar(scale);

                                    box.setFromObject(model);
                                    const newCenter = box.getCenter(new THREE.default.Vector3());
                                    model.position.sub(newCenter);
                                    model.position.y = 0;

                                    scene.add(model);
                                    addLog('Model added to scene!', 'success');
                                },
                                function(xhr) {
                                    const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                                    addLog(`Loading: ${percent}%`);
                                    statusEl.textContent = `Loading model: ${percent}%`;
                                },
                                function(error) {
                                    addLog(`ERROR loading GLTF: ${error.message}`, 'error');
                                    statusEl.textContent = 'Error loading model!';
                                    console.error(error);
                                }
                            );
                        })
                        .catch(error => {
                            addLog(`ERROR fetching file: ${error.message}`, 'error');
                            statusEl.textContent = 'File not accessible!';
                        });
                })
                .catch(error => {
                    addLog(`ERROR: ${error.message}`, 'error');
                    statusEl.textContent = 'Failed to load libraries!';
                    console.error(error);
                });
        } catch (error) {
            addLog(`CRITICAL ERROR: ${error.message}`, 'error');
            statusEl.textContent = 'Critical error!';
            console.error(error);
        }
    </script>
</body>
</html>
